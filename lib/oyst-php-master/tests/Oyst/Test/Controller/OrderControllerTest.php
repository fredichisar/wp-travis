<?php

namespace Oyst\Test\Controller;

use Oyst\Api\OystApiClientFactory;
use Oyst\Api\OystOrderApi;
use Oyst\Classes\Enum\AbstractOrderState;
use Oyst\Classes\OystOrder;
use Oyst\Test\TestSettings;

class OrderControllerTest extends \PHPUnit_Framework_TestCase
{
    /**
     * @var TestSettings
     */
    private $settings;

    /**
     * @var OystOrderApi
     */
    private $orderApi;

    protected function setUp()
    {
        $this->settings = new TestSettings();
        $this->settings->load();

        /** @var OystOrderApi $catalogApi */
        $this->orderApi = OystApiClientFactory::getClient(
            OystApiClientFactory::ENTITY_ORDER,
            $this->settings->getApiKey(),
            $this->settings->getUserAgent(),
            $this->settings->getEnv()
        );
    }

    public function testGetOrders()
    {
        $result = $this->orderApi->getOrders();

        $this->assertTrue(is_array($result['orders']) && isset($result['count']), $this->orderApi->getBody());
    }

    public function testUpdateOrder()
    {
        // TODO: This order part should work better with a new created order
        // As we can't create order on the API for real functional test, We need to create
        // a new one from live plugin and then register the id inside the settings here.

        // This part works, but we need to develop the post
        if (!$this->settings->getOrderId()) {
            return;
        }

        $orderInfo = $this->orderApi->getOrder($this->settings->getOrderId());

        $this->assertTrue(is_array($orderInfo), $this->orderApi->getBody());

        $currentState = $orderInfo['current_status'];

        if ($currentState == AbstractOrderState::WAITING) {
            $nextStatus = AbstractOrderState::PENDING;
        } elseif ($currentState == AbstractOrderState::PENDING) {
            $nextStatus = AbstractOrderState::ACCEPTED;
        } elseif ($currentState == AbstractOrderState::ACCEPTED) {
            $nextStatus = AbstractOrderState::FINALIZED;
        } elseif ($currentState == AbstractOrderState::FINALIZED) {
            $nextStatus = AbstractOrderState::SHIPPED;
        } else {
            $nextStatus = AbstractOrderState::PENDING;
        }

        $result = $this->orderApi->updateStatus($this->settings->getOrderId(), $nextStatus);

        $this->assertEquals(200, $this->orderApi->getLastHttpCode(), $this->orderApi->getBody());
        $this->assertEquals($nextStatus, $result['order']['current_status'], $this->orderApi->getBody());
    }
}
